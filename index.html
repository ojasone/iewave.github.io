<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheet Card Viewer</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card-img-top {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
        }
        .header-card {
            border: none;
        }
    </style>
</head>
<body>

    <div class="container my-4 my-md-5">
        <!-- Header and Input Section -->
        <div class="card shadow-sm p-3 mb-5 bg-body rounded header-card">
            <div class="card-body text-center">
                <h1 class="card-title h2 mb-3">Google Sheet Content Viewer</h1>
                <p class="card-text text-muted mb-4">
                    <strong>Important:</strong> Your Google Sheet must be published to the web as a CSV.
                    <br><small>Go to <code>File &gt; Share &gt; Publish to web</code> and select the CSV format.</small>
                </p>
                <div class="row justify-content-center">
                    <div class="col-md-8 col-lg-6">
                        <div class="input-group">
                            <input type="url" id="sheet-url" placeholder="Paste your standard Google Sheet URL here" class="form-control form-control-lg">
                            <button id="load-btn" class="btn btn-primary">Load Data</button>
                        </div>
                        <div id="csv-url-display" class="text-start mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Loader -->
        <div id="loader" class="text-center py-5 d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Error Messages -->
        <div id="error" class="alert alert-danger d-none" role="alert"></div>
        
        <!-- Card Container -->
        <div id="card-container" class="row g-4">
            <!-- Cards will be inserted here by JavaScript -->
        </div>
    </div>

    <script>
        document.getElementById('load-btn').addEventListener('click', loadSheetData);

        /**
         * Converts a standard Google Sheet URL to the necessary CSV export URL.
         * @param {string} url The original Google Sheet URL from the browser's address bar.
         * @returns {string|null} The converted URL for CSV export or null if the input URL is invalid.
         */
        function convertToCsvUrl(url) {
            const regex = /https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
            const match = url.match(regex);
            if (match && match[1]) {
                const sheetId = match[1];
                return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;
            }
            return null;
        }

        /**
         * Converts a Google Drive share URL to a direct image URL for embedding.
         * @param {string} url The original Google Drive file share URL.
         * @returns {string|null} The direct image URL or null if the input URL is invalid.
         */
        function convertToGoogleDriveImageUrl(url) {
            const regex = /https:\/\/drive\.google\.com\/file\/d\/([a-zA-Z0-9-_]+)/;
            const match = url.match(regex);
            if (match && match[1]) {
                const fileId = match[1];
                return `https://drive.google.com/uc?export=view&id=${fileId}`;
            }
            return null;
        }


        /**
         * Main function to fetch, parse, and display the sheet data.
         */
        async function loadSheetData() {
            const urlInput = document.getElementById('sheet-url').value;
            const cardContainer = document.getElementById('card-container');
            const loader = document.getElementById('loader');
            const errorDiv = document.getElementById('error');
            const csvUrlDisplay = document.getElementById('csv-url-display');

            // Reset UI for new data load
            cardContainer.innerHTML = '';
            errorDiv.classList.add('d-none');
            errorDiv.textContent = '';
            csvUrlDisplay.innerHTML = '';

            const csvUrl = convertToCsvUrl(urlInput);

            if (!csvUrl) {
                errorDiv.textContent = 'Invalid Google Sheet URL. Please paste the standard URL from your browser address bar.';
                errorDiv.classList.remove('d-none');
                return;
            }

            csvUrlDisplay.innerHTML = `<small class="text-muted text-break"><strong>Generated URL:</strong> <a href="${csvUrl}" target="_blank">${csvUrl}</a></small>`;

            loader.classList.remove('d-none');

            try {
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error(`Failed to fetch sheet. Status: ${response.statusText}`);
                }
                const csvText = await response.text();
                parseAndDisplayCsv(csvText);
            } catch (error) {
                console.error('Fetch Error:', error);
                errorDiv.textContent = 'Failed to load data. Please check the URL and ensure your sheet is published to the web as a CSV.';
                errorDiv.classList.remove('d-none');
            } finally {
                loader.classList.add('d-none');
            }
        }

        /**
         * Parses the raw CSV text and creates a card for each row.
         * Handles multi-line content within quoted fields.
         * @param {string} csvText The raw CSV data as a string.
         */
        function parseAndDisplayCsv(csvText) {
            const rowStrings = [];
            let currentRow = '';
            let inQuotes = false;

            // Normalize line endings and trim whitespace to reliably parse rows
            const normalizedCsv = csvText.trim().replace(/\r\n/g, '\n');

            for (const char of normalizedCsv) {
                if (char === '"') {
                    // This is a simplified quote toggle; assumes quotes are not escaped within fields
                    inQuotes = !inQuotes;
                }
                // A newline is only a row separator if we are not inside quotes
                if (char === '\n' && !inQuotes) {
                    rowStrings.push(currentRow);
                    currentRow = '';
                } else {
                    currentRow += char;
                }
            }
            // Add the last processed row
            if (currentRow) {
                rowStrings.push(currentRow);
            }

            const rows = rowStrings.filter(row => row.trim() !== ''); // Process all rows

            if (rows.length === 0) {
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = 'No data found in the sheet or the format is incorrect.';
                errorDiv.classList.remove('d-none');
                return;
            }

            rows.forEach(rowString => {
                const columns = [];
                let current = '';
                let inQuotesCol = false;
                for (let char of rowString) {
                    if (char === '"') {
                        inQuotesCol = !inQuotesCol;
                    } else if (char === ',' && !inQuotesCol) {
                        columns.push(current.trim().replace(/^"|"$/g, ''));
                        current = '';
                    } else {
                        current += char;
                    }
                }
                columns.push(current.trim().replace(/^"|"$/g, ''));
                
                if (columns.length >= 4) {
                    const serial = columns[0];
                    const message = columns[2];
                    const driveUrl = columns[3];
                    const imageUrl = columns[1];//convertToGoogleDriveImageUrl(driveUrl);
                    
                    if (imageUrl) { // Only create a card if the URL was converted successfully
                        createCard(serial, imageUrl, message);
                    } else {
                        console.warn(`Skipping row with invalid Google Drive URL: ${driveUrl}`);
                    }
                }
            });
        }

        /**
         * Creates a single card element and appends it to the container.
         * @param {string} serial The serial number (Column 1).
         * @param {string} imageUrl The image URL (Column 2).
         * @param {string} text The message text (Column 3), which may contain newlines.
         */
        function createCard(serial, imageUrl, text) {
            const cardContainer = document.getElementById('card-container');
            const col = document.createElement('div');
            // Responsive grid column
            col.className = 'col-12 col-sm-6 col-lg-4 col-xl-3'; 

            const card = document.createElement('div');
            card.className = 'card shadow-sm h-100';

            // To display newlines correctly in HTML, replace \n with <br>
            const formattedText = text.replace(/\n/g, '<br>');

            // Card Content
            card.innerHTML = `
                <div class="card-header">
                    <strong># ${serial}</strong>
                </div>
                <img src="${imageUrl}" class="card-img-top" alt="Image for ${serial}" crossorigin="anonymous">
                <div class="card-body d-flex flex-column">
                    <p class="card-text flex-grow-1">${formattedText}</p>
                </div>
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-secondary copy-btn">Copy</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary share-btn">Share</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary download-btn">Download</button>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="check-${serial}">
                        </div>
                    </div>
                </div>
            `;

            // Add Event Listeners for buttons in this card
            // Use the original 'text' with \n for clipboard and sharing
            card.querySelector('.copy-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Text copied!');
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    alert('Could not copy text.');
                });
            });

            card.querySelector('.share-btn').addEventListener('click', () => {
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
                window.open(whatsappUrl, '_blank');
            });

            card.querySelector('.download-btn').addEventListener('click', async () => {
                try {
                    const response = await fetch(imageUrl);
                    const blob = await response.blob();
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    
                    const filename = imageUrl.split('/').pop().split(/[?#]/)[0] || 'download.jpg';
                    link.download = filename;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                } catch (e) {
                    console.error("Download failed:", e);
                    alert("Could not download image. This may be due to the website's security policy (CORS).");
                }
            });
            
            col.appendChild(card);
            cardContainer.appendChild(col);
        }
    </script>
</body>
</html>





